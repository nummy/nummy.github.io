<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="description"><meta name="viewport" content="width=device-width, initial-scale=1"><title>runit快速入门 · Nummy</title><link rel="short icon" href="/favicon.ico"><!-- font--><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,600|Roboto Mono"><!-- icon--><link rel="stylesheet" href="/fonts/iconfont/iconfont.css"><!-- theme style--><link rel="stylesheet" href="/css/style.css"></head><body><div id="main"><header><a href="/." class="logo">Nummy</a><ul class="nav"><li class="nav-link"><a href="/" target="_self">Home</a></li><li class="nav-link"><a href="/archives/" target="_self">Archives</a></li><li class="nav-link"><a href="/categories/" target="_self">Categories</a></li><li class="nav-link"><a href="/tags/" target="_self">Tags</a></li><li class="nav-link"><a href="/about/" target="_self">About</a></li></ul></header><section id="container"><article class="post"><h1 class="post-title">runit快速入门</h1><span class="post-time">Aug 17, 2016</span><div id="sidebar" class="post-sidebar"><h3 class="heading">Directory</h3><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#概要"><span class="toc-text">概要</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#搭建环境"><span class="toc-text">搭建环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建模板"><span class="toc-text">创建模板</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#服务示例"><span class="toc-text">服务示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#管理服务"><span class="toc-text">管理服务</span></a></li></ol></div><div class="post-content"><h3 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h3><p>通过这篇教程，我们可以快速了解runit并搭建起相应服务。</p>
<p>runit是一个用于服务监控的UNIX软件，它提供以下两种服务：</p>
<ul>
<li>当服务器启动的时候启动定义好的服务。</li>
<li>监控运行的服务，当服务发生意外中断的时候，自动重启服务。</li>
</ul>
<p>这篇教程将通过一个简单的示例来讲解如何创建新的runit服务。如果你想了解更多信息，可以查看runit的<a href="http://smarden.org/runit/" target="_blank" rel="external">官方文档</a>。</p>
<p>本篇教程包括以下三部分：</p>
<ol>
<li>创建一个runit模板</li>
<li>创建第一个服务</li>
<li>如何自动管理服务</li>
</ol>
<h3 id="搭建环境"><a href="#搭建环境" class="headerlink" title="搭建环境"></a>搭建环境</h3><p>首先确保系统安装了runit，大多数Linux版本的软件仓库里都包哈了runit包。例如，如果你的系统是基于Debian的，则可以使用下面的命令进行安装：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># apt-get install runit</span></div></pre></td></tr></table></figure></p>
<p>如果是centos，则可以使用yum进行安装，但是默认情况下centos软件仓库里并没有runit，所以需要先配置相应的仓库：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># curl -s https://packagecloud.io/install/repositories/imeyer/runit/script.rpm.sh | sudo bash</div><div class="line"># sudo yum install runit-2.1.1-7.el7.centos.x86_64</div></pre></td></tr></table></figure></p>
<p>运行以下命令来检查是否已经安装了runit并且系统已经运行了runit。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ps -ef | grep runsvdir</span></div></pre></td></tr></table></figure></p>
<p>输出结果如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">root  2783   1  0 15:34 ? 00:00:00 runsvdir -P /etc/service log:</div></pre></td></tr></table></figure></p>
<p>runsvdir其实是一套组件，这些组件可以满足用户的各种需求，核心组件包括了runsvdir，runsv， chpst，svlogd以及sv。</p>
<h3 id="创建模板"><a href="#创建模板" class="headerlink" title="创建模板"></a>创建模板</h3><p>注意输出结果中的<code>runsvdir -P /etc/service log:.......</code>， 它的意思是runsvdir会监控<code>/etc/service/</code>目录下的文件，这些文件用于配置被监控的服务。</p>
<p>被监控的服务是通过在<code>/etc/service</code>目录下创建子目录，并添加可执行脚本run来实现的。</p>
<p>当runsvdir发现新的配置文件时，它就会自动启动一个runsv进程来管理这个配置的服务。</p>
<p>runit的设计思想就是每个组件的功能是完全独立的，以便管理。可以使用<code>man</code>命令查看具体组件的用法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># man runsvdir</div></pre></td></tr></table></figure></p>
<p>确保存在<code>/etc/service</code>，如果不存在，则使用mkdir创建相应目录：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># mkdir /etc/service</span></div></pre></td></tr></table></figure></p>
<p>为了便于开发与测试，这里我们不直接在<code>/etc/service/</code>目录中添加配置文件，而是创建一个暂存的目录来放置配置文件。<br>当我们满意自己的测试之后，再使用软链接，将暂存目录链接到<code>/etc/service</code>。</p>
<p>创建<code>/etc/runit</code>作为暂存目录。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># mkdir  /etc/runit</span></div></pre></td></tr></table></figure></p>
<p>在创建一个真正的runit服务之前，我们先创建一个模板。这个模板将展示runit的基本用法，以后可以直接使用这个模板创建新的服务。<br>首先创建template目录：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># mkdir /etc/runit/template</div></pre></td></tr></table></figure></p>
<p>接下来，创建run脚本：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">#!/bin/sh -e</div><div class="line">exec 2&gt;&amp;1</div><div class="line">exec chpst -u USER COMMAND</div></pre></td></tr></table></figure></p>
<p>给run添加可执行权限：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># chmod +x /etc/runit/template/run</span></div></pre></td></tr></table></figure></p>
<p>这个脚本首先将标准错误输出流输出到标准输出流，然后执行chpst命令。chpst命令用来指定使用哪个用户执行命令。由于run脚本默认被root用户执行，通过chpst可以将run配置为普通用户来执行。通过man命令可以查看chpst的更多信息。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># man chpst</span></div></pre></td></tr></table></figure></p>
<p>当runsvdir检查到<code>/etc/service</code>目录下包含一个新的目录时，runsvdir会启动一个runsv进程来执行和监控run脚本。通过man命令查看runsv的更多信息：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#man runsv</span></div></pre></td></tr></table></figure></p>
<p>你可能注意runsv还可以监控日志服务，日志在应用中非常的重要。下面创建一个日志模板。</p>
<p>首先创建log目录：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># mkdir /etc/runit/template/log</span></div></pre></td></tr></table></figure></p>
<p>然后创建run脚本：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/sh</span></div><div class="line"><span class="built_in">exec</span> chpst -u USER svlogd -tt LOGDIR</div></pre></td></tr></table></figure></p>
<p>给run脚本添加可执行权限：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># chmod +x /etc/runit/template/log/run</div></pre></td></tr></table></figure></p>
<p>上面的脚本使用chpst启动一个svlogd守护进程，该进程将日志信息写到LOGDIR目录中。<br>使用man命令获取更多关于svlodg的信息：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># man svlogd</span></div></pre></td></tr></table></figure></p>
<p>当runsvdir在<code>/etc/service/</code>目录中发现新的配置时，它会继续查找子目录log，如果找到了则启动runsv进程来执行和监控log目录下的run脚本。</p>
<h3 id="服务示例"><a href="#服务示例" class="headerlink" title="服务示例"></a>服务示例</h3><p>接下来，我们使用上面创建的模板来创建一个简单的服务配置。首先创建需要再run脚本中被chpst使用的用户:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># adduser foo</div></pre></td></tr></table></figure></p>
<p>接下来创建放置服务配置的目录，并将它的所属用户与用户组设置为foo。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># mkdir /opt/example</span></div><div class="line"><span class="comment"># chown foo:foo /opt/example</span></div></pre></td></tr></table></figure></p>
<p>接下来切换到foo用户：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># su foo</span></div></pre></td></tr></table></figure></p>
<p>在<code>/opt/example</code>目录中添加脚本foo-service.sh：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"></div><div class="line"><span class="built_in">echo</span> <span class="string">"Started service..."</span></div><div class="line"></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..30&#125;</div><div class="line"><span class="keyword">do</span></div><div class="line">    <span class="built_in">echo</span> <span class="string">"Doing stuff..."</span></div><div class="line">    sleep 1</div><div class="line"><span class="keyword">done</span></div><div class="line"></div><div class="line"><span class="built_in">echo</span> <span class="string">"Oh no I crashed..."</span> &gt;&amp;2</div><div class="line"><span class="built_in">exit</span> 1</div></pre></td></tr></table></figure></p>
<p>给脚本赋予执行权限：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># chmod +x /opt/example/foo-service.sh</div></pre></td></tr></table></figure></p>
<p>上面的脚本模拟了一个真实的应用，每隔1秒打印一次日志信息，最后打印一次错误信息。可以尝试执行这个脚本：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># /opt/example/foo-service.sh</div></pre></td></tr></table></figure></p>
<p>接下来创建包含日志服务的目录：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># mkdir /opt/example/logs</span></div></pre></td></tr></table></figure></p>
<p>再切换回root用户。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># exit</div></pre></td></tr></table></figure></p>
<p>接下来使用之前创建的模板来监控这个示例服务，将暂存目录中的模板文件拷贝至新的目录example:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># cp -R /etc/runit/template /etc/runit/example</div></pre></td></tr></table></figure></p>
<p>更新<code>/etc/runit/example/run</code>脚本的内容，使用foo用户来执行foo-service.sh脚本。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">#!/bin/sh -e</div><div class="line">exec 2&gt;&amp;1</div><div class="line">exec chpst -u foo /opt/example/foo-service.sh</div></pre></td></tr></table></figure></p>
<p>同样的，更新<code>/etc/runit/example/log/run</code>脚本内容：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">#!/bin/sh</div><div class="line">exec chpst -u foo svlogd -tt /opt/example/logs</div></pre></td></tr></table></figure></p>
<p>在将服务部署到<code>/etc/service</code>前，首先测试下配置是否正确：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># /etc/runit/example/run</div></pre></td></tr></table></figure></p>
<p>如果脚本运行正常，就可以部署服务了，创建一个软链接：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># ln -s /etc/runit/example /etc/service/example</div></pre></td></tr></table></figure></p>
<p>不出意外的话，runsvdir会检测到我们配置的两个服务，然后启动两个runsv进程来执行并监控服务。通过下面的命令可以检测服务是否正常运行。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># sv status example</span></div></pre></td></tr></table></figure></p>
<p>输出结果如下所示：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">run: example: (pid 3483) 3s; run: <span class="built_in">log</span>: (pid 3324) 154s</div></pre></td></tr></table></figure></p>
<p>使用tail命令可以查看日志信息：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># tail -f /opt/example/logs/current</span></div></pre></td></tr></table></figure></p>
<p>你会看到日志信息以及异常信息，接着服务重启。</p>
<h3 id="管理服务"><a href="#管理服务" class="headerlink" title="管理服务"></a>管理服务</h3><p>最后，我们再来学习下sv用法，sv用来手动管理我们的服务。</p>
<ol>
<li><p>检查服务的状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sv status example</div></pre></td></tr></table></figure>
</li>
<li><p>停止服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sv stop example</div></pre></td></tr></table></figure>
</li>
</ol>
<p>停止服务之后不会再输出日志信息，也不会再自动重启。</p>
<ol>
<li><p>重启服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sv restart example</div></pre></td></tr></table></figure>
</li>
<li><p>更多用法<br>``<br>man sv<br>```</p>
</li>
</ol>
<blockquote>
<p>译自：<a href="http://kchard.github.io/runit-quickstart/" target="_blank" rel="external">runit quick start</a></p>
</blockquote>
</div></article><div class="tags"><a href="/tags/linux/">linux</a></div><div class="paginator"><a href="/2016/09/03/scala-base/" class="prev"><i class="iconfont icon-left"></i><span> Prev</span></a><a href="/2016/03/23/iterator-vs-generator/" class="next"><span>Next</span><i class="iconfont icon-right"></i></a></div><section id="comments"><div data-thread-key="http://nummy.github.io/2016/08/17/runit-quick-tutorial/index.html" data-title="runit快速入门" data-url="http://nummy.github.io/2016/08/17/runit-quick-tutorial/index.html" class="ds-thread"></div><script type="text/javascript">var duoshuoQuery = {short_name: "nummy" };
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
})();</script></section></section><footer><div class="copyright"><p>&copy;2016<span class="heart"><i class="iconfont icon-heart"></i></span><span class="author">Nummy Lee</span></p><p class="theme">Theme by <a href="https://github.com/ahonn/hexo-theme-even"> Even</a></p></div><label id="back2top"><i class="iconfont icon-up"></i></label></footer></div></body><script src="/js/zepto.min.js"></script><script src="/js/theme.js"></script></html>